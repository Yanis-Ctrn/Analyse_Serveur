import json
import requests
from requests.auth import HTTPDigestAuth
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def stream_to_file(url, file_name, auth):
    with requests.get(url, auth=auth, stream=True, verify=False) as r:
        r.raise_for_status()

        with open(file_name, 'w') as file:
            obj_depth = 0
            current_obj = ''
            
            # Utilisez un chunk size plus petit
            for chunk in r.iter_content(chunk_size=128, decode_unicode=True): 
                for char in chunk:
                    current_obj += char
                    if char == '{':
                        obj_depth += 1
                    elif char == '}':
                        obj_depth -= 1

                        if obj_depth == 0:
                            try:
                                json_object = json.loads(current_obj)
                                file.write(json.dumps(json_object) + "\n") # Ajouter un saut de ligne pour chaque objet JSON
                                current_obj = ''  # Réinitialiser pour le prochain objet JSON
                            except json.JSONDecodeError:
                                pass  # Gérer l'erreur de décodage

if __name__ == "__main__":
    username = 'catarinoya'
    password = 'QBVMaq237!.bmzW.yctv'
    url_perimetre = "https://cockpit.intranatixis.com/query/api/json/174"
    url_serveur = "https://cockpit.intranatixis.com/query/api/json/260"
    
    stream_to_file(url_perimetre, "info_api_p.json", (username, password))
    stream_to_file(url_serveur, "info_api_s.json", (username, password))
    print("1")

import json
import requests
from requests.auth import HTTPDigestAuth
from requests.packages.urllib3.exceptions import InsecureRequestWarning

# Supprimer cette partie si vous avez un certificat valide
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def process_json_stream(url, auth):
    with requests.get(url, auth=auth, stream=True, verify=False) as r:
        r.raise_for_status()

        obj_depth = 0
        current_obj = ''

        for chunk in r.iter_content(chunk_size=1, decode_unicode=True):
            current_obj += chunk
            if chunk == '{':
                obj_depth += 1
            elif chunk == '}':
                obj_depth -= 1

                if obj_depth == 0:
                    # Un objet JSON complet a été lu
                    try:
                        data = json.loads(current_obj)
                        # Traitez l'objet JSON ici
                        print(data)  # Ou écrivez-le dans un fichier, etc.
                    except json.JSONDecodeError:
                        # Gérer une éventuelle erreur de décodage
                        pass

                    current_obj = ''  # Réinitialiser pour le prochain objet JSON

def main():
    username = 'catarinoya'
    password = 'QBVMaq237!.bmzW.yctv'
    url = "https://cockpit.intranatixis.com/query/api/json/174"
    process_json_stream(url, (username, password))

if __name__ == "__main__":
    main()
